- name: Copy repository to server (excluding terraform and ansible)
  synchronize:
    src: "{{ playbook_dir }}/.."
    dest: /home/ubuntu/e-commerce-microservices
    recursive: yes
    delete: no
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=terraform/"
      - "--exclude=ansible/"

- name: Create backend .env file from example
  copy:
    src: "{{ playbook_dir }}/../backend/config/config.env.example"
    dest: /home/ubuntu/e-commerce-microservices/backend/config/.env
    owner: ubuntu
    group: ubuntu
    mode: "0644"

- name: Run docker-compose
  shell: |
    cd /home/ubuntu/e-commerce-microservices
    docker-compose down || true
    docker-compose up -d
